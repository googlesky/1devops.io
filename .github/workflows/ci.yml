name: CI - Quality Checks

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate HTML & Links

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate HTML
        run: |
          echo "üîç Validating HTML structure..."
          if grep -q "<!DOCTYPE html>" index.html; then
            echo "‚úÖ DOCTYPE found"
          else
            echo "‚ùå DOCTYPE missing"
            exit 1
          fi

          if grep -q "</html>" index.html; then
            echo "‚úÖ HTML structure valid"
          else
            echo "‚ùå HTML structure invalid"
            exit 1
          fi

      - name: Check for CNAME
        run: |
          echo "üîç Checking CNAME configuration..."
          if [ -f "CNAME" ]; then
            echo "‚úÖ CNAME file exists"
            echo "Domain: $(cat CNAME)"
          else
            echo "‚ö†Ô∏è  CNAME file not found"
          fi

      - name: Verify required files
        run: |
          echo "üîç Verifying required files..."
          files=("index.html" ".nojekyll" "README.md")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ùå $file missing"
              exit 1
            fi
          done

      - name: Check file sizes
        run: |
          echo "üìä File sizes:"
          ls -lh index.html README.md

          size=$(wc -c < index.html)
          if [ $size -gt 1048576 ]; then
            echo "‚ö†Ô∏è  Warning: index.html is larger than 1MB"
          else
            echo "‚úÖ File size is optimal"
          fi

      - name: Security scan
        run: |
          echo "üîí Running basic security checks..."

          # Check for potential XSS vulnerabilities
          if grep -i "eval(" index.html; then
            echo "‚ö†Ô∏è  Warning: Found eval() - potential security risk"
          fi

          # Check for inline event handlers
          if grep -iE "on(click|load|error|mouseover)=" index.html; then
            echo "‚ö†Ô∏è  Warning: Found inline event handlers"
          else
            echo "‚úÖ No inline event handlers found"
          fi

          # Check for external scripts from untrusted sources
          if grep -iE "src=\"http[^\"]*\"" index.html | grep -v "fonts.googleapis.com"; then
            echo "‚ö†Ô∏è  Warning: External scripts detected"
          else
            echo "‚úÖ No external scripts from untrusted sources"
          fi

  performance:
    runs-on: ubuntu-latest
    name: Performance Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze bundle
        run: |
          echo "üì¶ Analyzing page weight..."

          total_size=0
          for file in index.html README.md; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              total_size=$((total_size + size))
              echo "  $file: $(numfmt --to=iec-i --suffix=B $size)"
            fi
          done

          echo "Total size: $(numfmt --to=iec-i --suffix=B $total_size)"

          if [ $total_size -lt 524288 ]; then
            echo "‚úÖ Excellent: Total size under 512KB"
          elif [ $total_size -lt 1048576 ]; then
            echo "‚úÖ Good: Total size under 1MB"
          else
            echo "‚ö†Ô∏è  Warning: Total size exceeds 1MB"
          fi

      - name: Check for optimization opportunities
        run: |
          echo "üéØ Checking optimization opportunities..."

          # Check if CSS is minified
          if grep -q "^[[:space:]]*$" index.html; then
            lines=$(grep -c "^[[:space:]]*$" index.html || true)
            echo "üìù Found $lines blank lines - consider minification"
          fi

          # Check for comments
          comments=$(grep -c "<!--" index.html || true)
          if [ $comments -gt 0 ]; then
            echo "üìù Found $comments HTML comments"
          fi

          echo "‚úÖ Analysis complete"

  lint:
    runs-on: ubuntu-latest
    name: Lint Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check code style
        run: |
          echo "üé® Checking code style..."

          # Check indentation consistency
          if grep -qP "^\t" index.html && grep -qP "^    " index.html; then
            echo "‚ö†Ô∏è  Warning: Mixed tabs and spaces detected"
          else
            echo "‚úÖ Consistent indentation"
          fi

          # Check for trailing whitespace
          if grep -q "[[:space:]]$" index.html; then
            echo "‚ö†Ô∏è  Warning: Trailing whitespace found"
          else
            echo "‚úÖ No trailing whitespace"
          fi

          # Check line endings
          if file index.html | grep -q "CRLF"; then
            echo "‚ö†Ô∏è  Warning: Windows line endings (CRLF) detected"
          else
            echo "‚úÖ Unix line endings (LF)"
          fi
